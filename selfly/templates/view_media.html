{% extends "base.html" %}

{% block title %}View Media{% endblock %}

{% block content %}
<div class="relative w-full h-full flex flex-col justify-center items-center">
    <!-- Action buttons container -->
    <div class="absolute top-4 left-4 z-10 flex space-x-4">
        <!-- Back Button -->
        <a href="{{ url_for('main.dashboard') }}"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-200">
            &larr; Back
        </a>

        <!-- Delete Button -->
        <a href="{{ url_for('main.delete_file', filename=filename) }}"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-200"
            onclick="return confirm('Are you sure you want to delete this file? This action cannot be undone.');">
            Delete
        </a>
    </div>

    <!-- Media Container -->
    <div class="max-w-full max-h-screen p-4 flex justify-center items-center">
        {% if filename.endswith(('png', 'jpg', 'jpeg', 'gif')) %}
        <img id="zoomable-image" src="{{ url_for('main.serve_media', filename=filename) }}" alt="{{ filename }}"
            class="max-w-full max-h-full cursor-zoom-in transition-transform duration-300 ease-in-out">
        {% elif filename.endswith(('mp4', 'mov', 'avi')) %}
        <video controls autoplay class="max-w-full max-h-full rounded-lg shadow-xl">
            <source src="{{ url_for('main.serve_media', filename=filename) }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        {% endif %}
    </div>

    <!-- Right-side panel for metadata and upload -->
    {% if filename.endswith(('png', 'jpg', 'jpeg', 'gif')) %}
    <div class="absolute top-4 right-4 z-10 flex flex-col space-y-2">
        <button id="toggle-metadata-btn"
            class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-200">
            Show Metadata
        </button>
        <button id="upload-image-btn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-200">
            Upload & Copy Link
        </button>
    </div>

    <!-- Metadata Panel -->
    <div id="metadata-panel"
        class="absolute bottom-4 left-4 z-10 p-4 bg-gray-800 text-white rounded-lg shadow-lg hidden max-w-sm">
        <h4 class="text-lg font-bold mb-2">Metadata</h4>
        <div id="metadata-content" class="text-sm">
            <!-- Metadata will be populated here -->
        </div>
    </div>
    {% endif %}

    <!-- Custom Message Box for notifications -->
    <div id="message-box"
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-xl hidden z-50 transition-opacity duration-300">
        <!-- Messages will appear here -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const image = document.getElementById('zoomable-image');
        const toggleMetadataBtn = document.getElementById('toggle-metadata-btn');
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const metadataPanel = document.getElementById('metadata-panel');
        const metadataContent = document.getElementById('metadata-content');
        const messageBox = document.getElementById('message-box');

        // Function to show a custom message
        function showMessage(message, duration = 3000) {
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        // --- Zoom functionality ---
        if (image) {
            let isZoomed = false;
            image.addEventListener('click', function () {
                if (isZoomed) {
                    image.style.transform = 'scale(1)';
                    image.style.cursor = 'zoom-in';
                } else {
                    image.style.transform = 'scale(2)';
                    image.style.cursor = 'zoom-out';
                }
                isZoomed = !isZoomed;
            });
        }

        // --- Metadata functionality ---
        if (toggleMetadataBtn && metadataPanel && metadataContent) {
            function updateMetadataDisplay(metadata) {
                metadataContent.innerHTML = ''; // Clear existing content
                for (const [key, value] of Object.entries(metadata)) {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="font-semibold">${key}:</span> ${value}`;
                    metadataContent.appendChild(p);
                }
            }

            toggleMetadataBtn.addEventListener('click', async function () {
                const isHidden = metadataPanel.classList.contains('hidden');
                if (isHidden) {
                    showMessage('Fetching metadata...');
                    try {
                        const response = await fetch(`/api/metadata/{{ filename }}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch metadata.');
                        }
                        const metadata = await response.json();
                        updateMetadataDisplay(metadata);
                        metadataPanel.classList.remove('hidden');
                        toggleMetadataBtn.textContent = 'Hide Metadata';
                    } catch (error) {
                        console.error('Metadata fetch error:', error);
                        showMessage('Failed to load metadata.', 5000);
                    }
                } else {
                    metadataPanel.classList.add('hidden');
                    toggleMetadataBtn.textContent = 'Show Metadata';
                }
            });
        }

        // --- Upload & Copy functionality ---
        if (uploadImageBtn && image) {
            uploadImageBtn.addEventListener('click', async function () {
                const proceed = window.confirm(
                    "Warning: This will make this image public to everyone, even those without the link. Proceed?"
                );

                if (proceed) {
                    showMessage('Uploading image...');
                    try {
                        const response = await fetch(`/api/upload-public/{{ filename }}`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            throw new Error('Upload failed.');
                        }

                        const result = await response.json();
                        const publicLink = result.public_link;

                        // Copy the link to clipboard
                        const textarea = document.createElement('textarea');
                        textarea.value = publicLink;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);

                        showMessage('Link copied to clipboard!');
                    } catch (error) {
                        console.error('Upload Error:', error);
                        showMessage('Failed to upload image. Check the console for details.', 5000);
                    }
                }
            });
        }
    });
</script>
{% endblock %}