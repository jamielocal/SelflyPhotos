{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome, {{ username }}!</h2>
{% if files %}
<h3 class="text-xl font-semibold text-gray-700 mb-4">Your Media</h3>
<div class="media-grid" id="media-grid">
    {% for file in files %}
    <div class="media-item" data-filename="{{ file }}">
        {% if file.endswith(('png', 'jpg', 'jpeg', 'gif')) %}
        <img src="{{ url_for('main.serve_media', filename=file) }}" alt="{{ file }}">
        {% elif file.endswith(('mp4', 'mov', 'avi')) %}
        <video controls src="{{ url_for('main.serve_media', filename=file) }}"></video>
        {% endif %}
        <div class="media-actions">
            <a href="{{ url_for('main.view_media', filename=file) }}" class="text-white hover:underline">View</a>
            <a href="{{ url_for('main.delete_file', filename=file) }}" class="text-red-400 hover:underline"
                onclick="return confirm('Are you sure you want to delete this file?');">Delete</a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Loading indicator and observer target -->
<div id="loading-indicator" class="text-center py-4 text-gray-500 {% if not has_more %}hidden{% endif %}">
    Loading more media...
</div>
<div id="scroll-trigger" data-has-more="{{ 'true' if has_more else 'false' }}"></div>

{% else %}
<div class="text-center py-12">
    <p class="text-gray-500 text-lg">You haven't added any media yet.</p>
    <a href="{{ url_for('main.upload_file') }}"
        class="mt-4 inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
        Upload Your First File
    </a>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('media-grid');
        const scrollTrigger = document.getElementById('scroll-trigger');
        const loadingIndicator = document.getElementById('loading-indicator');
        let currentPage = 1;
        const itemsPerPage = 20;
        let hasMore = scrollTrigger.dataset.hasMore === 'true';

        function createMediaItem(filename) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('media-item');
            itemDiv.dataset.filename = filename;

            let mediaHTML;
            if (filename.match(/\.(png|jpg|jpeg|gif)$/i)) {
                mediaHTML = `<img src="{{ url_for('main.serve_media', filename='') }}${filename}" alt="${filename}">`;
            } else if (filename.match(/\.(mp4|mov|avi)$/i)) {
                mediaHTML = `<video controls src="{{ url_for('main.serve_media', filename='') }}${filename}"></video>`;
            }

            const actionsHTML = `
                <div class="media-actions">
                    <a href="{{ url_for('main.view_media', filename='') }}${filename}" class="text-white hover:underline">View</a>
                    <a href="{{ url_for('main.delete_file', filename='') }}${filename}" class="text-red-400 hover:underline" onclick="return confirm('Are you sure you want to delete this file?');">Delete</a>
                </div>
            `;

            itemDiv.innerHTML = mediaHTML + actionsHTML;
            return itemDiv;
        }

        async function loadMoreMedia() {
            if (!hasMore) {
                loadingIndicator.classList.add('hidden');
                return;
            }

            loadingIndicator.classList.remove('hidden');

            try {
                currentPage++;
                const response = await fetch(`/api/media?page=${currentPage}&per_page=${itemsPerPage}`);
                const data = await response.json();

                data.files.forEach(filename => {
                    const item = createMediaItem(filename);
                    grid.appendChild(item);
                });

                hasMore = data.has_more;
                scrollTrigger.dataset.hasMore = hasMore;
            } catch (error) {
                console.error('Error fetching more media:', error);
            } finally {
                if (!hasMore) {
                    loadingIndicator.classList.add('hidden');
                }
            }
        }

        // Use IntersectionObserver to detect when the trigger element is visible
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMoreMedia();
                }
            });
        }, {
            rootMargin: '100px', // Trigger a bit before the bottom
            threshold: 0.1
        });

        // Start observing the trigger element if it exists
        if (scrollTrigger) {
            observer.observe(scrollTrigger);
        }
    });
</script>
{% endblock %}